--Creating staging tables
CREATE TABLE stgProductCategory (
    CategoryID INT,
    CategoryName VARCHAR(100)
);

CREATE TABLE stgProductSubcategory (
    SubcategoryID INT,
    SubcategoryName VARCHAR(100),
    CategoryID INT
);

--Populate staging tables
INSERT INTO stgProductCategory (CategoryID, CategoryName) VALUES
(1, 'Electronics'),
(2, 'Home Appliances');

INSERT INTO stgProductSubcategory (SubcategoryID, SubcategoryName, CategoryID) VALUES
(101, 'Mobile Phones', 1),
(102, 'Laptops', 1),
(201, 'Refrigerators', 2),
(202, 'Washing Machines', 2);


-- Incorrect Product Dimension as primary, foreign keys not supported.
CREATE TABLE DimProduct (
    ProductKey BIGINT PRIMARY KEY,
    ProductID INT,
    Name VARCHAR(100),
    Brand VARCHAR(50),
    SubcategoryID INT
);


-- Correct Create Product Dimension
CREATE TABLE DimProduct (
    ProductKey BIGINT, ProductID INT, Name VARCHAR(100), Brand VARCHAR(50), SubcategoryID INT
);

-- Populate DimProduct
WITH DistinctProducts AS (
    SELECT DISTINCT ProductID, Name, Brand, SubcategoryID
    FROM [lakehouse01].[dbo].[flatsales]
)
INSERT INTO DimProduct (ProductKey, ProductID, Name, Brand, SubcategoryID)
SELECT 
    ROW_NUMBER() OVER (ORDER BY ProductID) AS ProductKey, ProductID, Name, Brand, SubcategoryID
FROM DistinctProducts;

SELECT * FROM DimProduct

--Create Enriched DimProduct
CREATE TABLE DimProductEnriched AS
SELECT 
    dp.ProductKey,
    dp.ProductID,
    dp.Name,
    dp.Brand,
    ps.SubcategoryName,
    pc.CategoryName
FROM DimProduct dp
LEFT JOIN stgProductSubcategory ps 
    ON dp.SubcategoryID = ps.SubcategoryID
LEFT JOIN stgProductCategory pc 
    ON ps.CategoryID = pc.CategoryID;

SELECT * FROM DimProductEnriched



-- Create FactSales
CREATE TABLE FactSales (
    TransactionID INT,
    TransactionDate DATE,
    Amount DECIMAL(10,2),
    ProductKey INT
);

-- Populate FactSales
INSERT INTO FactSales (TransactionID, TransactionDate, Amount, ProductKey)
SELECT
    fs.TransactionID,
    fs.Date,
    fs.Amount,
    dp.ProductKey
FROM [lakehouse01].[dbo].[flatsales] fs
JOIN DimProduct dp 
  ON fs.ProductID = dp.ProductID;